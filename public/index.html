<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Chat seguro</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" href="/favicon.ico" />
    <link rel="manifest" href="/site.webmanifest">

    <style>
        * {
            box-sizing: border-box;
            /*Hola IVAN */
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at top, #202c33 0, #0b141a 45%, #000 100%);
            color: #111;
        }

        /* Contenedor principal del chat */
        .chat-wrapper {
            width: 100%;
            max-width: 960px;
            height: 90vh;
            max-height: 720px;
            background: #111b21;
            border-radius: 18px;
            overflow: hidden;
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            border: 1px solid #202c33;
        }

        header {
            background: linear-gradient(90deg, #128c7e, #075e54);
            color: white;
            padding: 10px 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.2);
        }

        header h2 {
            margin: 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        header h2 span.logo {
            display: inline-flex;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.7);
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        #estado {
            font-size: 0.8rem;
            margin-top: 2px;
            opacity: 0.85;
        }

        /* Layout interior: arriba barra de clave + mensajes, abajo input */
        .chat-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        /* Barra de clave de cifrado (antes login) */
        #login {
            padding: 10px 14px;
            background: #202c33;
            color: #e9edef;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            border-bottom: 1px solid #202c33;
        }

        #login label {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        #login input {
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid #374045;
            background: #111b21;
            color: #e9edef;
            font-size: 0.9rem;
        }

        #login input::placeholder {
            color: #8696a0;
        }

        #login button {
            padding: 8px 16px;
            border: none;
            background: #25d366;
            color: #111b21;
            cursor: pointer;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
        }

        #login button:hover {
            background: #20bd59;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            transform: translateY(-1px);
        }

        #mensajeLogin {
            min-width: 220px;
            font-size: 0.8rem;
        }

        .oculto {
            display: none !important;
        }

        /* Zona de mensajes */
        #mensajes {
            list-style: none;
            margin: 0;
            padding: 16px 12px;
            flex: 1;
            overflow-y: auto;
            background:
                radial-gradient(circle at top left, rgba(32, 44, 51, 0.6), transparent 60%),
                radial-gradient(circle at bottom right, rgba(32, 44, 51, 0.6), transparent 55%),
                #0b141a;
            position: relative;
        }

        #mensajes::-webkit-scrollbar {
            width: 6px;
        }

        #mensajes::-webkit-scrollbar-track {
            background: transparent;
        }

        #mensajes::-webkit-scrollbar-thumb {
            background: #374045;
            border-radius: 3px;
        }

        #mensajes li.mensaje {
            margin-bottom: 4px;
            max-width: 75%;
            padding: 6px 10px;
            border-radius: 12px;
            display: block !important;
            position: relative;
            word-wrap: break-word;
            font-size: 0.9rem;
        }

        /* Nuevo grupo de mensajes (cuando cambia de persona) */
        #mensajes li.mensaje.nuevo-grupo {
            margin-top: 12px;
        }

        /* Mensajes de otros (izquierda) */
        #mensajes li.otro {
            background: #202c33;
            color: #e9edef;
            align-self: flex-start;
        }

        /* Mensajes míos (derecha) */
        #mensajes li.mio {
            background: #005c4b;
            color: #e9edef;
            margin-left: auto;
        }

        #mensajes li .texto {
            font-size: 0.9rem;
        }

        #mensajes li .hora {
            font-size: 0.7rem;
            opacity: 0.8;
            margin-top: 2px;
            text-align: right;
        }

        /* Barra inferior de envío */
        #formulario {
            display: flex;
            padding: 10px;
            background: #202c33;
            border-top: 1px solid #202c33;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
        }

        #input {
            flex: 1;
            padding: 10px 14px;
            border-radius: 999px;
            border: none;
            outline: none;
            font-size: 0.95rem;
            background: #111b21;
            color: #e9edef;
        }

        #input::placeholder {
            color: #8696a0;
        }

        #btn {
            padding: 10px 16px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            background: #25d366;
            color: #111b21;
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
        }

        #btn span.icon {
            font-size: 1rem;
        }

        #btn:hover:not(:disabled) {
            background: #20bd59;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            transform: translateY(-1px);
        }

        #formulario input:disabled,
        #formulario button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Responsive pequeño */
        @media (max-width: 640px) {
            .chat-wrapper {
                height: 100vh;
                border-radius: 0;
            }

            #login {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>

<body>
    <div class="chat-wrapper">
        <header>
            <h2>
                <span class="logo">E2</span>
                Developers Team
            </h2>
            <div id="estado">Conectando...</div>
        </header>

        <div class="chat-body">
            <!-- Barra de clave de cifrado -->
            <div id="login">
                <label>Contraseña cifrado (no se envía al servidor):</label>
                <input id="claveCifrado" placeholder="Secreta compartida" type="password" />
                <button id="btnClave">Usar clave</button>
                <span id="mensajeLogin"></span>
            </div>

            <!-- Lista de mensajes -->
            <ul id="mensajes"></ul>

            <!-- Formulario de envío -->
            <div id="formulario">
                <input id="input" autocomplete="off" placeholder="Escribe un mensaje..." disabled />
                <button id="btn" disabled>
                    <span class="icon">➤</span>
                    Enviar
                </button>
            </div>
        </div>
    </div>

    <!-- Cliente de Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        const input = document.getElementById("input");
        const btn = document.getElementById("btn");
        const lista = document.getElementById("mensajes");

        const claveCifradoInput = document.getElementById("claveCifrado");
        const btnClave = document.getElementById("btnClave");
        const mensajeLogin = document.getElementById("mensajeLogin");
        const estado = document.getElementById("estado");

        let cryptoKey = null; // clave derivada de la contraseña de cifrado
        let miAutorId = null; // ID anónimo que asigna el servidor a este cliente
        let ultimoAutor = null; // para agrupar mensajes consecutivos de la misma persona
        let bufferMensajesPendientes = []; // mensajes recibidos antes de tener la clave

        const PASS_STORAGE_KEY = "chatE2E_pass_v1";

        function guardarPass(password) {
            try {
                localStorage.setItem(PASS_STORAGE_KEY, password);
            } catch (e) {
                console.warn("No se pudo guardar la contraseña localmente:", e);
            }
        }

        function cargarPass() {
            try {
                return localStorage.getItem(PASS_STORAGE_KEY);
            } catch (e) {
                console.warn("No se pudo leer la contraseña guardada:", e);
                return null;
            }
        }

        // ---------- UTILIDADES DE CIFRADO ----------

        function strToUint8Array(str) {
            return new TextEncoder().encode(str);
        }

        function uint8ArrayToBase64(bytes) {
            let binary = "";
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        function base64ToUint8Array(base64) {
            const binary = atob(base64);
            const len = binary.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes;
        }

        async function deriveKeyFromPassword(password) {
            const pwdBytes = strToUint8Array(password);
            const salt = strToUint8Array("SALT-FIJO-DEL-CHAT-EXPERIMENTAL");

            const baseKey = await crypto.subtle.importKey(
                "raw",
                pwdBytes,
                { name: "PBKDF2" },
                false,
                ["deriveKey"]
            );

            const key = await crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: salt,
                    iterations: 100000,
                    hash: "SHA-256",
                },
                baseKey,
                { name: "AES-GCM", length: 256 },
                false,
                ["encrypt", "decrypt"]
            );

            return key;
        }

        async function encryptText(plainText) {
            if (!cryptoKey) throw new Error("No hay clave de cifrado");

            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encoded = strToUint8Array(plainText);

            const cipherBuffer = await crypto.subtle.encrypt(
                { name: "AES-GCM", iv },
                cryptoKey,
                encoded
            );

            const cipherBytes = new Uint8Array(cipherBuffer);

            return {
                cipherTextBase64: uint8ArrayToBase64(cipherBytes),
                ivBase64: uint8ArrayToBase64(iv),
            };
        }

        async function decryptText(cipherTextBase64, ivBase64) {
            if (!cryptoKey) throw new Error("No hay clave de cifrado");

            const cipherBytes = base64ToUint8Array(cipherTextBase64);
            const iv = base64ToUint8Array(ivBase64);

            const plainBuffer = await crypto.subtle.decrypt(
                { name: "AES-GCM", iv },
                cryptoKey,
                cipherBytes
            );

            const plainText = new TextDecoder().decode(new Uint8Array(plainBuffer));
            return plainText;
        }

        // ---------- UI MENSAJES ----------

        function agregarMensajeALaLista(data) {
            const li = document.createElement("li");
            li.classList.add("mensaje");

            // Agrupar mensajes consecutivos del mismo autor
            if (data.autor !== ultimoAutor) {
                li.classList.add("nuevo-grupo");
                ultimoAutor = data.autor;
            }

            // Mensajes míos (derecha) vs otros (izquierda)
            if (miAutorId && data.autor === miAutorId) {
                li.classList.add("mio");
            } else {
                li.classList.add("otro");
            }

            li.innerHTML = `
                <div class="texto">${data.texto}</div>
                <div class="hora">${data.fecha}</div>
            `;

            lista.appendChild(li);
            lista.scrollTop = lista.scrollHeight;
        }

        async function procesarBufferSiClaveLista() {
            if (!cryptoKey || bufferMensajesPendientes.length === 0) return;

            const pendientes = bufferMensajesPendientes;
            bufferMensajesPendientes = [];

            for (const m of pendientes) {
                try {
                    const texto = await decryptText(m.cipherText, m.iv);
                    agregarMensajeALaLista({
                        autor: m.autor,
                        texto,
                        fecha: m.fecha,
                    });
                } catch (err) {
                    console.warn("No se pudo descifrar un mensaje:", err);
                    const li = document.createElement("li");
                    li.classList.add("mensaje", "otro", "nuevo-grupo");
                    li.innerHTML = `
                        <div class="texto">[No se pudo descifrar el mensaje]</div>
                        <div class="hora">${m.fecha}</div>
                    `;
                    lista.appendChild(li);
                }
            }
        }

        // ---------- CONFIGURAR CLAVE DE CIFRADO ----------

        btnClave.onclick = async () => {
            const passwordCifrado = claveCifradoInput.value.trim();

            if (!passwordCifrado) {
                mensajeLogin.textContent = "Escribe una contraseña de cifrado.";
                mensajeLogin.style.color = "salmon";
                return;
            }

            try {
                mensajeLogin.textContent = "Derivando clave de cifrado...";
                mensajeLogin.style.color = "#e9edef";

                cryptoKey = await deriveKeyFromPassword(passwordCifrado);

                mensajeLogin.textContent = "Clave de cifrado lista.";
                mensajeLogin.style.color = "#25d366";
                input.disabled = false;
                btn.disabled = false;
                estado.textContent = "Conectado (clave configurada)";

                // Ocultar la barra de clave después de entrar correctamente
                document.getElementById("login").classList.add("oculto");


                // Guardar la contraseña localmente para futuros reloads
                guardarPass(passwordCifrado);

                // Intentar procesar cualquier mensaje pendiente
                procesarBufferSiClaveLista();
            } catch (err) {
                console.error(err);
                mensajeLogin.textContent = "Error derivando clave de cifrado.";
                mensajeLogin.style.color = "salmon";
            }
        };

        // Permitir Enter en la clave para activarla
        claveCifradoInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                btnClave.click();
            }
        });

        // ---------- HISTORIAL Y MENSAJES ----------

        socket.on("identidad", (data) => {
            miAutorId = data.autor;
        });

        socket.on("historial", (mensajesCifrados) => {
            lista.innerHTML = "";
            ultimoAutor = null;
            bufferMensajesPendientes.push(...mensajesCifrados);
            procesarBufferSiClaveLista();
        });

        socket.on("mensaje", (m) => {
            bufferMensajesPendientes.push(m);
            procesarBufferSiClaveLista();
        });

        // ---------- ENVÍO DE MENSAJES ----------

        btn.onclick = async () => {
            if (!cryptoKey) {
                alert("Primero debes configurar la clave de cifrado.");
                return;
            }

            const texto = input.value.trim();
            if (!texto) return;

            try {
                const { cipherTextBase64, ivBase64 } = await encryptText(texto);

                const data = {
                    cipherText: cipherTextBase64,
                    iv: ivBase64,
                    fecha: new Date().toLocaleTimeString(),
                };

                socket.emit("mensaje", data);
                input.value = "";
            } catch (err) {
                console.error("Error cifrando mensaje:", err);
                alert("Error cifrando mensaje.");
            }
        };

        input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                btn.click();
            }
        });

        // ---------- ESTADO DE CONEXIÓN ----------

        socket.on("connect", () => {
            console.log("Conectado al servidor de sockets");
            if (!cryptoKey) {
                estado.textContent = "Conectado (esperando clave de cifrado)";
            }
        });

        socket.on("disconnect", () => {
            console.log("Desconectado del servidor de sockets");
            estado.textContent = "Desconectado";
            input.disabled = true;
            btn.disabled = true;
        });

        // ---------- AUTOCARGA DE CONTRASEÑA GUARDADA ----------

        (function init() {
            const passGuardada = cargarPass();
            if (passGuardada) {
                claveCifradoInput.value = passGuardada;
                mensajeLogin.textContent = "Pulsa Enter";
                mensajeLogin.style.color = "#e9edef";
            }
        })();
    </script>
</body>

</html>