<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Chat seguro</title>

    <!-- Viewport para responsive -->
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" href="/favicon.ico" />
    <link rel="manifest" href="/site.webmanifest">

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, "Segoe UI", Arial, sans-serif;
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f7;
            color: #111827;
        }

        /* Contenedor principal */
        .chat-wrapper {
            width: 100%;
            max-width: 960px;
            height: 90vh;
            max-height: 720px;
            background: #ffffff;
            border-radius: 32px;
            overflow: hidden;
            box-shadow: 0 24px 60px rgba(0, 0, 0, 0.10);
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(0, 0, 0, 0.04);
        }

        header {
            background: #ffffff;
            color: #111827;
            padding: 14px 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        header h2 {
            margin: 0;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        header h2 span.logo {
            display: inline-flex;
            width: 24px;
            height: 24px;
            border-radius: 999px;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            background: #111827;
            color: #ffffff;
        }

        #estado {
            font-size: 0.78rem;
            margin-top: 4px;
            opacity: 0.7;
        }

        /* Layout interior */
        .chat-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #f5f5f7;
        }

        /* Barra de clave de cifrado */
        #login {
            padding: 10px 16px;
            background: #f9fafb;
            color: #111827;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            border-bottom: 1px solid rgba(15, 23, 42, 0.06);
        }

        #login label {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        #login input {
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            background: #ffffff;
            color: #111827;
            font-size: 0.85rem;
            outline: none;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        #login input::placeholder {
            color: #9ca3af;
        }

        #login input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
        }

        #login button {
            padding: 8px 16px;
            border: none;
            background: #2563eb;
            color: #ffffff;
            cursor: pointer;
            border-radius: 999px;
            font-weight: 500;
            font-size: 0.85rem;
            transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease;
        }

        #login button:hover {
            background: #1d4ed8;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
            transform: translateY(-1px);
        }

        #mensajeLogin {
            min-width: 220px;
            font-size: 0.78rem;
        }

        .oculto {
            display: none !important;
        }

        /* Zona de mensajes */
        #mensajes {
            list-style: none;
            margin: 0;
            padding: 16px 14px 8px;
            flex: 1;
            overflow-y: auto;
            background: #f5f5f7;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        #mensajes::-webkit-scrollbar {
            width: 6px;
        }

        #mensajes::-webkit-scrollbar-track {
            background: transparent;
        }

        #mensajes::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.8);
            border-radius: 999px;
        }

        #mensajes li.mensaje {
            margin-top: 2px;
            /* casi pegados por defecto */
            margin-bottom: 2px;
            max-width: 72%;
            padding: 8px 12px;
            border-radius: 18px;
            display: block !important;
            position: relative;
            word-wrap: break-word;
            font-size: 0.85rem;
            line-height: 1.35;
        }

        /* Primer mensaje de un grupo (cambia autor) => más espacio arriba */
        #mensajes li.mensaje.nuevo-grupo {
            margin-top: 14px;
        }

        /* Mensajes de otros (izquierda) – estilo gris claro */
        #mensajes li.otro {
            background: #e5e7eb;
            color: #111827;
            align-self: flex-start;
            border-bottom-left-radius: 18px;
            border-top-left-radius: 18px;
        }

        /* Mensajes míos (derecha) – estilo azul iMessage */
        #mensajes li.mio {
            background: #007aff;
            color: #ffffff;
            margin-left: auto;
            border-bottom-right-radius: 18px;
            border-top-right-radius: 18px;
        }

        /* Ajuste visual para mensajes consecutivos del mismo autor:
           la burbuja "intermedia" se ve más continua */
        #mensajes li.mensaje.mio+li.mensaje.mio {
            border-top-right-radius: 8px;
        }

        #mensajes li.mensaje.otro+li.mensaje.otro {
            border-top-left-radius: 8px;
        }

        #mensajes li .texto {
            font-size: 0.86rem;
        }

        #mensajes li .hora {
            font-size: 0.7rem;
            opacity: 0.8;
            margin-top: 2px;
            text-align: right;
        }

        /* Barra inferior de envío */
        #formulario {
            display: flex;
            padding: 10px 12px 14px;
            background: #f9fafb;
            border-top: 1px solid rgba(15, 23, 42, 0.06);
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
        }

        #input {
            flex: 1;
            padding: 10px 14px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.7);
            outline: none;
            font-size: 0.9rem;
            background: #ffffff;
            color: #111827;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        #input::placeholder {
            color: #9ca3af;
        }

        #input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
        }

        #btn {
            width: 40px;
            height: 40px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            background: #2563eb;
            color: #ffffff;
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease;
        }

        #btn span.icon {
            font-size: 1rem;
            transform: translateX(1px);
        }

        #btn:hover:not(:disabled) {
            background: #1d4ed8;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.35);
            transform: translateY(-1px);
        }

        #formulario input:disabled,
        #formulario button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* ===== RESPONSIVE ===== */

        /* Móviles */
        @media (max-width: 640px) {
            body {
                background: #ffffff;
                min-height: 100dvh;
                padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            }

            .chat-wrapper {
                height: 100dvh;
                max-height: none;
                max-width: 100%;
                border-radius: 0;
                box-shadow: none;
                border: none;
            }

            header {
                padding: 10px 16px;
            }

            header h2 {
                font-size: 0.95rem;
            }

            #login {
                flex-direction: column;
                align-items: stretch;
                gap: 6px;
            }

            #login input,
            #login button {
                width: 100%;
            }

            #mensajes {
                padding: 10px 8px 6px;
            }

            #mensajes li.mensaje {
                max-width: 82%;
                font-size: 0.84rem;
            }

            #formulario {
                padding: 8px 10px 10px;
            }

            #input {
                font-size: 0.88rem;
            }
        }

        /* Tablets */
        @media (min-width: 641px) and (max-width: 1024px) {
            .chat-wrapper {
                max-width: 820px;
                height: 88vh;
                max-height: none;
                border-radius: 24px;
            }
        }
    </style>
</head>

<body>
    <div class="chat-wrapper">
        <header>
            <h2>
                <span class="logo">E2</span>
                Developers Team
            </h2>
            <div id="estado">Conectando...</div>
        </header>

        <div class="chat-body">
            <!-- Barra de clave de cifrado -->
            <div id="login">
                <label>Contraseña cifrado (no se envía al servidor):</label>
                <input id="claveCifrado" placeholder="Secreta compartida" type="password" />
                <button id="btnClave">Usar clave</button>
                <span id="mensajeLogin"></span>
            </div>

            <!-- Lista de mensajes -->
            <ul id="mensajes"></ul>

            <!-- Formulario de envío -->
            <div id="formulario">
                <input id="input" autocomplete="off" placeholder="Escribe un mensaje..." disabled />
                <button id="btn" disabled>
                    <span class="icon">➤</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Cliente de Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        const input = document.getElementById("input");
        const btn = document.getElementById("btn");
        const lista = document.getElementById("mensajes");

        const claveCifradoInput = document.getElementById("claveCifrado");
        const btnClave = document.getElementById("btnClave");
        const mensajeLogin = document.getElementById("mensajeLogin");
        const estado = document.getElementById("estado");

        let cryptoKey = null; // clave derivada de la contraseña de cifrado
        let miAutorId = null; // ID anónimo que asigna el servidor a este cliente
        let ultimoAutor = null; // para agrupar mensajes consecutivos de la misma persona
        let bufferMensajesPendientes = []; // mensajes recibidos antes de tener la clave

        const PASS_STORAGE_KEY = "chatE2E_pass_v1";

        function guardarPass(password) {
            try {
                localStorage.setItem(PASS_STORAGE_KEY, password);
            } catch (e) {
                console.warn("No se pudo guardar la contraseña localmente:", e);
            }
        }

        function cargarPass() {
            try {
                return localStorage.getItem(PASS_STORAGE_KEY);
            } catch (e) {
                console.warn("No se pudo leer la contraseña guardada:", e);
                return null;
            }
        }

        // ---------- UTILIDADES DE CIFRADO ----------

        function strToUint8Array(str) {
            return new TextEncoder().encode(str);
        }

        function uint8ArrayToBase64(bytes) {
            let binary = "";
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        function base64ToUint8Array(base64) {
            const binary = atob(base64);
            const len = binary.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes;
        }

        async function deriveKeyFromPassword(password) {
            const pwdBytes = strToUint8Array(password);
            const salt = strToUint8Array("SALT-FIJO-DEL-CHAT-EXPERIMENTAL");

            const baseKey = await crypto.subtle.importKey(
                "raw",
                pwdBytes,
                { name: "PBKDF2" },
                false,
                ["deriveKey"]
            );

            const key = await crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: salt,
                    iterations: 100000,
                    hash: "SHA-256",
                },
                baseKey,
                { name: "AES-GCM", length: 256 },
                false,
                ["encrypt", "decrypt"]
            );

            return key;
        }

        async function encryptText(plainText) {
            if (!cryptoKey) throw new Error("No hay clave de cifrado");

            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encoded = strToUint8Array(plainText);

            const cipherBuffer = await crypto.subtle.encrypt(
                { name: "AES-GCM", iv },
                cryptoKey,
                encoded
            );

            const cipherBytes = new Uint8Array(cipherBuffer);

            return {
                cipherTextBase64: uint8ArrayToBase64(cipherBytes),
                ivBase64: uint8ArrayToBase64(iv),
            };
        }

        async function decryptText(cipherTextBase64, ivBase64) {
            if (!cryptoKey) throw new Error("No hay clave de cifrado");

            const cipherBytes = base64ToUint8Array(cipherTextBase64);
            const iv = base64ToUint8Array(ivBase64);

            const plainBuffer = await crypto.subtle.decrypt(
                { name: "AES-GCM", iv },
                cryptoKey,
                cipherBytes
            );

            const plainText = new TextDecoder().decode(new Uint8Array(plainBuffer));
            return plainText;
        }

        // ---------- UI MENSAJES ----------

        function agregarMensajeALaLista(data) {
            const li = document.createElement("li");
            li.classList.add("mensaje");

            if (data.autor !== ultimoAutor) {
                li.classList.add("nuevo-grupo");
                ultimoAutor = data.autor;
            }

            if (miAutorId && data.autor === miAutorId) {
                li.classList.add("mio");
            } else {
                li.classList.add("otro");
            }

            li.innerHTML = `
                <div class="texto">${data.texto}</div>
                <div class="hora">${data.fecha}</div>
            `;

            lista.appendChild(li);
            lista.scrollTop = lista.scrollHeight;
        }

        async function procesarBufferSiClaveLista() {
            if (!cryptoKey || bufferMensajesPendientes.length === 0) return;

            const pendientes = bufferMensajesPendientes;
            bufferMensajesPendientes = [];

            for (const m of pendientes) {
                try {
                    const texto = await decryptText(m.cipherText, m.iv);
                    agregarMensajeALaLista({
                        autor: m.autor,
                        texto,
                        fecha: m.fecha,
                    });
                } catch (err) {
                    console.warn("No se pudo descifrar un mensaje:", err);
                    const li = document.createElement("li");
                    li.classList.add("mensaje", "otro", "nuevo-grupo");
                    li.innerHTML = `
                        <div class="texto">[No se pudo descifrar el mensaje]</div>
                        <div class="hora">${m.fecha}</div>
                    `;
                    lista.appendChild(li);
                }
            }
        }

        // ---------- CONFIGURAR CLAVE DE CIFRADO ----------

        btnClave.onclick = async () => {
            const passwordCifrado = claveCifradoInput.value.trim();

            if (!passwordCifrado) {
                mensajeLogin.textContent = "Escribe una contraseña de cifrado.";
                mensajeLogin.style.color = "salmon";
                return;
            }

            try {
                mensajeLogin.textContent = "Derivando clave de cifrado...";
                mensajeLogin.style.color = "#4b5563";

                cryptoKey = await deriveKeyFromPassword(passwordCifrado);

                mensajeLogin.textContent = "Clave de cifrado lista.";
                mensajeLogin.style.color = "#16a34a";
                input.disabled = false;
                btn.disabled = false;
                estado.textContent = "Conectado (clave configurada)";

                document.getElementById("login").classList.add("oculto");

                guardarPass(passwordCifrado);

                procesarBufferSiClaveLista();
            } catch (err) {
                console.error(err);
                mensajeLogin.textContent = "Error derivando clave de cifrado.";
                mensajeLogin.style.color = "salmon";
            }
        };

        claveCifradoInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                btnClave.click();
            }
        });

        // ---------- HISTORIAL Y MENSAJES ----------

        socket.on("identidad", (data) => {
            miAutorId = data.autor;
        });

        socket.on("historial", (mensajesCifrados) => {
            lista.innerHTML = "";
            ultimoAutor = null;
            bufferMensajesPendientes.push(...mensajesCifrados);
            procesarBufferSiClaveLista();
        });

        socket.on("mensaje", (m) => {
            bufferMensajesPendientes.push(m);
            procesarBufferSiClaveLista();
        });

        // ---------- ENVÍO DE MENSAJES ----------

        btn.onclick = async () => {
            if (!cryptoKey) {
                alert("Primero debes configurar la clave de cifrado.");
                return;
            }

            const texto = input.value.trim();
            if (!texto) return;

            try {
                const { cipherTextBase64, ivBase64 } = await encryptText(texto);

                const data = {
                    cipherText: cipherTextBase64,
                    iv: ivBase64,
                    fecha: new Date().toLocaleTimeString(),
                };

                socket.emit("mensaje", data);
                input.value = "";
            } catch (err) {
                console.error("Error cifrando mensaje:", err);
                alert("Error cifrando mensaje.");
            }
        };

        input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                btn.click();
            }
        });

        // ---------- ESTADO DE CONEXIÓN ----------

        socket.on("connect", () => {
            console.log("Conectado al servidor de sockets");
            if (!cryptoKey) {
                estado.textContent = "Conectado (esperando clave de cifrado)";
            }
        });

        socket.on("disconnect", () => {
            console.log("Desconectado del servidor de sockets");
            estado.textContent = "Desconectado";
            input.disabled = true;
            btn.disabled = true;
        });

        // ---------- AUTOCARGA DE CONTRASEÑA GUARDADA ----------

        (function init() {
            const passGuardada = cargarPass();
            if (passGuardada) {
                claveCifradoInput.value = passGuardada;
                mensajeLogin.textContent = "Pulsa Enter";
                mensajeLogin.style.color = "#4b5563";
            }
        })();
    </script>
</body>

</html>